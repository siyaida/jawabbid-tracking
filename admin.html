<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jawabid v2 | Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a1628;--bg2:#0f1f35;--bg3:#162a46;
  --orange:#e8913a;--orange-glow:#e8913a55;
  --blue:#4a9eff;--green:#22c55e;--amber:#f59e0b;
  --red:#ef4444;--purple:#a855f7;--cyan:#06b6d4;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --card:#0f1f35cc;--card-border:#1e3a5f;
  --font:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;
}
html{scrollbar-width:thin;scrollbar-color:var(--orange) var(--bg)}
body{font-family:var(--font);background:var(--bg);color:var(--text);overflow-x:hidden;line-height:1.6}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--orange);border-radius:3px}

/* Login Overlay */
.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity 0.5s,visibility 0.5s}
.login-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none}
.login-box{background:var(--card);border:1px solid var(--card-border);border-radius:20px;padding:48px;width:100%;max-width:400px;text-align:center;box-shadow:0 40px 80px rgba(0,0,0,0.5)}
.login-box h2{font-size:1.8rem;font-weight:800;margin-bottom:8px}
.login-box h2 span{color:var(--orange)}
.login-box p{color:var(--text3);font-size:0.9rem;margin-bottom:32px}
.login-field{width:100%;padding:14px 18px;border:1px solid var(--card-border);border-radius:10px;background:var(--bg2);color:var(--text);font-family:var(--font);font-size:0.95rem;outline:none;transition:border-color 0.3s;margin-bottom:12px}
.login-field:focus{border-color:var(--orange)}
.login-field::placeholder{color:var(--text3)}
.login-btn{width:100%;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--orange),var(--amber));color:#000;font-family:var(--font);font-size:1rem;font-weight:700;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;margin-top:8px}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--orange-glow)}
.login-error{color:var(--red);font-size:0.85rem;margin-top:12px;min-height:20px;opacity:0;transition:opacity 0.3s}
.login-error.show{opacity:1}

/* Header */
.header{padding:20px 40px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);background:rgba(10,22,40,0.9);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100}
.header-logo{font-weight:800;font-size:1.2rem}
.header-logo span{color:var(--orange)}
.header-badge{padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:600;background:rgba(232,145,58,0.15);color:var(--orange);font-family:var(--mono)}

/* Layout */
.dashboard{display:grid;grid-template-columns:360px 1fr;min-height:calc(100vh - 65px)}
.sidebar{border-right:1px solid var(--card-border);overflow-y:auto;background:var(--bg2)}
.main-content{overflow-y:auto;padding:32px;max-height:calc(100vh - 65px)}

/* Session List */
.session-header{padding:20px 20px 12px;border-bottom:1px solid var(--card-border)}
.session-header h3{font-size:1rem;font-weight:700;margin-bottom:4px}
.session-header .count{font-size:0.8rem;color:var(--text3);font-family:var(--mono)}
.session-item{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.2s}
.session-item:hover{background:rgba(255,255,255,0.03)}
.session-item.active{background:rgba(232,145,58,0.08);border-left:3px solid var(--orange)}
.session-item .si-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.session-item .si-user{font-weight:600;font-size:0.95rem}
.session-item .si-status{display:inline-flex;align-items:center;gap:5px;font-size:0.72rem;font-family:var(--mono);padding:3px 8px;border-radius:4px}
.si-status.live{background:rgba(34,197,94,0.15);color:var(--green)}
.si-status.live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.si-status.ended{background:rgba(100,116,139,0.15);color:var(--text3)}
.session-item .si-meta{display:flex;gap:16px;font-size:0.78rem;color:var(--text3)}
.session-item .si-meta span{display:flex;align-items:center;gap:4px}

/* No Session Selected */
.no-session{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);text-align:center;gap:12px}
.no-session svg{width:64px;height:64px;opacity:0.3}
.no-session p{font-size:1rem}

/* Session Detail */
.detail-header{margin-bottom:32px}
.detail-header h2{font-size:1.6rem;font-weight:800;margin-bottom:8px}
.detail-meta{display:flex;flex-wrap:wrap;gap:16px;font-size:0.85rem;color:var(--text2)}
.detail-meta .dm-item{display:flex;align-items:center;gap:6px}
.detail-meta .dm-label{color:var(--text3);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
.stat-card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:20px;text-align:center}
.stat-card .sc-num{font-family:var(--mono);font-size:1.8rem;font-weight:700;line-height:1}
.stat-card .sc-label{font-size:0.75rem;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px}

/* Chart Containers */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px}
.chart-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:24px;overflow:hidden}
.chart-card.full-width{grid-column:1/-1}
.chart-card h4{font-size:0.9rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.chart-card h4 .dot{width:8px;height:8px;border-radius:50%}
.chart-card canvas{width:100%;display:block}

/* Event Timeline */
.event-timeline{max-height:500px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--card-border) transparent}
.event-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.82rem}
.event-item:last-child{border:none}
.event-item .ei-time{font-family:var(--mono);color:var(--text3);flex-shrink:0;width:85px;font-size:0.75rem}
.event-item .ei-type{flex-shrink:0;width:100px;font-family:var(--mono);font-size:0.72rem;padding:2px 8px;border-radius:4px;text-align:center;height:fit-content}
.ei-type.click{background:rgba(74,158,255,0.15);color:var(--blue)}
.ei-type.scroll{background:rgba(168,85,247,0.15);color:var(--purple)}
.ei-type.section_enter{background:rgba(34,197,94,0.15);color:var(--green)}
.ei-type.section_exit{background:rgba(239,68,68,0.15);color:var(--red)}
.ei-type.hover{background:rgba(245,158,11,0.15);color:var(--amber)}
.ei-type.nav_click{background:rgba(6,182,212,0.15);color:var(--cyan)}
.ei-type.visibility{background:rgba(100,116,139,0.15);color:var(--text3)}
.ei-type.mouse_batch{background:rgba(232,145,58,0.15);color:var(--orange)}
.ei-type.resize{background:rgba(100,116,139,0.15);color:var(--text3)}
.event-item .ei-detail{color:var(--text2);flex:1}

/* Nav Path */
.nav-path{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.nav-path .np-item{padding:6px 14px;border-radius:8px;background:var(--bg3);font-size:0.82rem;font-weight:500;border:1px solid var(--card-border)}
.nav-path .np-arrow{color:var(--text3);font-size:0.8rem}

/* Heatmap overlay */
.heatmap-container{position:relative;width:100%;aspect-ratio:16/9;background:var(--bg3);border-radius:8px;overflow:hidden}
.heatmap-container canvas{width:100%;height:100%}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text3);gap:8px}
.loading::before{content:'';width:16px;height:16px;border:2px solid var(--text3);border-top-color:var(--orange);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:900px){
  .dashboard{grid-template-columns:1fr}
  .sidebar{max-height:300px}
  .main-content{max-height:none}
  .stats-grid{grid-template-columns:1fr 1fr}
  .charts-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Admin <span>Dashboard</span></h2>
    <p>Enter admin credentials to view tracking data</p>
    <input type="text" class="login-field" id="loginUser" placeholder="Username" autocomplete="off">
    <input type="password" class="login-field" id="loginPass" placeholder="Password">
    <button class="login-btn" id="loginBtn">Sign In</button>
    <div class="login-error" id="loginError">Invalid credentials. Please try again.</div>
  </div>
</div>

<!-- Header -->
<header class="header" id="appHeader" style="display:none">
  <div class="header-logo">JAWABID <span>v2</span> &mdash; Admin</div>
  <span class="header-badge">TRACKING DASHBOARD</span>
</header>

<!-- Dashboard -->
<div class="dashboard" id="appDashboard" style="display:none">
  <!-- Sidebar: Session List -->
  <div class="sidebar">
    <div class="session-header">
      <h3>Sessions</h3>
      <div class="count" id="sessionCount">Loading...</div>
    </div>
    <div id="sessionList"><div class="loading">Loading sessions...</div></div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="no-session" id="noSession">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a8.25 8.25 0 0116.5 0"/></svg>
      <p>Select a session to view activity details</p>
    </div>
    <div id="sessionDetail" style="display:none"></div>
  </div>
</div>

<!-- Firebase Config (gitignored - contains your credentials) -->
<script src="firebase-config.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// ===== FIREBASE CONFIG =====
// REPLACE THIS with your Firebase project config (same as index.html)
// IMPORTANT: Create a firebase-config.js file (gitignored) with your config
// See README.md for setup instructions
const firebaseConfig = window.FIREBASE_CONFIG || {
  apiKey: "",
  authDomain: "",
  databaseURL: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== LOGIN =====
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const c = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + c;
    hash |= 0;
  }
  return hash;
}

const ADMIN_CREDS = { user: simpleHash('admin'), pass: simpleHash('admin2026') };

const loginOverlay = document.getElementById('loginOverlay');
const loginBtn = document.getElementById('loginBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginError = document.getElementById('loginError');

if (sessionStorage.getItem('jawabid_admin')) {
  loginOverlay.classList.add('hidden');
  showDashboard();
}

loginBtn.addEventListener('click', attemptLogin);
loginPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptLogin(); });
loginUser.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginPass.focus(); });

function attemptLogin() {
  const user = loginUser.value.trim();
  const pass = loginPass.value;
  if (simpleHash(user) === ADMIN_CREDS.user && simpleHash(pass) === ADMIN_CREDS.pass) {
    loginError.classList.remove('show');
    sessionStorage.setItem('jawabid_admin', 'true');
    loginOverlay.classList.add('hidden');
    showDashboard();
  } else {
    loginError.classList.add('show');
    loginPass.value = '';
    loginPass.focus();
  }
}

// ===== DASHBOARD =====
let allSessions = {};
let currentSessionId = null;
let sessionListener = null;

function showDashboard() {
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appDashboard').style.display = '';
  loadSessions();
}

function loadSessions() {
  const sessionsRef = db.ref('jawabid-tracking/sessions');
  sessionsRef.on('value', (snapshot) => {
    allSessions = snapshot.val() || {};
    renderSessionList();
    // If we have a selected session, refresh its detail
    if (currentSessionId && allSessions[currentSessionId]) {
      renderSessionDetail(currentSessionId);
    }
  });
}

function renderSessionList() {
  const list = document.getElementById('sessionList');
  const entries = Object.entries(allSessions).sort((a, b) => (b[1].startTime || 0) - (a[1].startTime || 0));

  document.getElementById('sessionCount').textContent = entries.length + ' session' + (entries.length !== 1 ? 's' : '');

  if (entries.length === 0) {
    list.innerHTML = '<div style="padding:20px;color:var(--text3);text-align:center;font-size:0.9rem">No sessions yet. Share the site link to start tracking.</div>';
    return;
  }

  list.innerHTML = entries.map(([id, s]) => {
    const isActive = s.status === 'active';
    const startDate = new Date(s.startTime);
    const duration = s.endTime ? formatDuration(s.endTime - s.startTime) : 'ongoing';
    const timeStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                    startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    return `<div class="session-item ${currentSessionId === id ? 'active' : ''}" onclick="selectSession('${id}')">
      <div class="si-top">
        <span class="si-user">${escHtml(s.user || 'Unknown')}</span>
        <span class="si-status ${isActive ? 'live' : 'ended'}">${isActive ? 'LIVE' : 'ENDED'}</span>
      </div>
      <div class="si-meta">
        <span>${timeStr}</span>
        <span>${duration}</span>
      </div>
    </div>`;
  }).join('');
}

function selectSession(id) {
  currentSessionId = id;
  renderSessionList(); // re-render to highlight active
  renderSessionDetail(id);
}

function renderSessionDetail(id) {
  const session = allSessions[id];
  if (!session) return;

  document.getElementById('noSession').style.display = 'none';
  const detail = document.getElementById('sessionDetail');
  detail.style.display = '';

  const startDate = new Date(session.startTime);
  const duration = session.endTime ? formatDuration(session.endTime - session.startTime) : 'ongoing';
  const activeDuration = session.activeTime ? formatDuration(session.activeTime) : 'N/A';

  // Collect events into an array
  const events = [];
  if (session.events) {
    Object.entries(session.events).forEach(([eid, ev]) => {
      events.push({ id: eid, ...ev });
    });
  }
  events.sort((a, b) => a.timestamp - b.timestamp);

  // Compute stats
  const clicks = events.filter(e => e.type === 'click');
  const scrollEvents = events.filter(e => e.type === 'scroll');
  const sectionEnters = events.filter(e => e.type === 'section_enter');
  const sectionExits = events.filter(e => e.type === 'section_exit');
  const hovers = events.filter(e => e.type === 'hover');
  const navClicks = events.filter(e => e.type === 'nav_click');
  const mouseBatches = events.filter(e => e.type === 'mouse_batch');
  const maxScrollPct = scrollEvents.reduce((max, e) => Math.max(max, e.data?.scrollPct || 0), 0);

  // Section time calculation
  const sectionTimeMap = {};
  sectionExits.forEach(e => {
    const sec = e.data?.section;
    if (sec) {
      sectionTimeMap[sec] = (sectionTimeMap[sec] || 0) + (e.data.duration || 0);
    }
  });

  // Navigation path
  const navPath = [];
  sectionEnters.forEach(e => {
    const sec = e.data?.section;
    if (sec && (navPath.length === 0 || navPath[navPath.length - 1] !== sec)) {
      navPath.push(sec);
    }
  });

  detail.innerHTML = `
    <div class="detail-header">
      <h2>${escHtml(session.user || 'Unknown')}'s Session</h2>
      <div class="detail-meta">
        <div class="dm-item"><span class="dm-label">Started</span> ${startDate.toLocaleString()}</div>
        <div class="dm-item"><span class="dm-label">Duration</span> ${duration}</div>
        <div class="dm-item"><span class="dm-label">Active Time</span> ${activeDuration}</div>
        <div class="dm-item"><span class="dm-label">Screen</span> ${escHtml(session.screenSize || 'N/A')}</div>
        <div class="dm-item"><span class="dm-label">Status</span> <span style="color:${session.status === 'active' ? 'var(--green)' : 'var(--text3)'}">${session.status || 'unknown'}</span></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="sc-num" style="color:var(--blue)">${clicks.length}</div><div class="sc-label">Clicks</div></div>
      <div class="stat-card"><div class="sc-num" style="color:var(--purple)">${maxScrollPct.toFixed(0)}%</div><div class="sc-label">Max Scroll</div></div>
      <div class="stat-card"><div class="sc-num" style="color:var(--green)">${Object.keys(sectionTimeMap).length}</div><div class="sc-label">Sections Viewed</div></div>
      <div class="stat-card"><div class="sc-num" style="color:var(--amber)">${hovers.length}</div><div class="sc-label">Element Hovers</div></div>
    </div>

    <!-- Navigation Path -->
    <div class="chart-card full-width" style="margin-bottom:24px">
      <h4><span class="dot" style="background:var(--cyan)"></span> Navigation Path</h4>
      <div class="nav-path">
        ${navPath.length > 0 ? navPath.map((s, i) => `<span class="np-item">${escHtml(s)}</span>${i < navPath.length - 1 ? '<span class="np-arrow">&rarr;</span>' : ''}`).join('') : '<span style="color:var(--text3)">No navigation data</span>'}
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h4><span class="dot" style="background:var(--orange)"></span> Time Per Section</h4>
        <canvas id="chartSectionTime" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h4><span class="dot" style="background:var(--purple)"></span> Scroll Depth Over Time</h4>
        <canvas id="chartScrollDepth" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h4><span class="dot" style="background:var(--blue)"></span> Click Map</h4>
        <div class="heatmap-container"><canvas id="chartClickMap"></canvas></div>
      </div>
      <div class="chart-card">
        <h4><span class="dot" style="background:var(--red)"></span> Mouse Heatmap</h4>
        <div class="heatmap-container"><canvas id="chartMouseHeat"></canvas></div>
      </div>
    </div>

    <!-- Event Timeline -->
    <div class="chart-card full-width" style="margin-top:0">
      <h4><span class="dot" style="background:var(--green)"></span> Event Timeline (${events.length} events)</h4>
      <div class="event-timeline" id="eventTimeline"></div>
    </div>
  `;

  // Render charts
  drawSectionTimeChart(sectionTimeMap);
  drawScrollDepthChart(scrollEvents, session.startTime);
  drawClickMap(clicks);
  drawMouseHeatmap(mouseBatches);
  renderEventTimeline(events, session.startTime);
}

// ===== CHART: Section Time (horizontal bar) =====
function drawSectionTimeChart(sectionTimeMap) {
  const canvas = document.getElementById('chartSectionTime');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * dpr;
  canvas.height = 250 * dpr;
  ctx.scale(dpr, dpr);
  const W = canvas.offsetWidth, H = 250;

  const entries = Object.entries(sectionTimeMap).sort((a, b) => b[1] - a[1]);
  if (entries.length === 0) {
    ctx.fillStyle = '#64748b';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('No section data yet', W / 2, H / 2);
    return;
  }

  const maxVal = Math.max(...entries.map(e => e[1]));
  const barH = Math.min(28, (H - 20) / entries.length - 6);
  const labelW = 90;
  const barMaxW = W - labelW - 70;

  entries.forEach(([section, ms], i) => {
    const y = 10 + i * (barH + 6);
    // Label
    ctx.fillStyle = '#94a3b8';
    ctx.font = '11px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText(section, labelW - 8, y + barH / 2 + 4);

    // Bar
    const barW = maxVal > 0 ? (ms / maxVal) * barMaxW : 0;
    const grad = ctx.createLinearGradient(labelW, 0, labelW + barW, 0);
    grad.addColorStop(0, '#e8913a');
    grad.addColorStop(1, '#f59e0b');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.roundRect(labelW, y, barW, barH, 4);
    ctx.fill();

    // Value
    ctx.fillStyle = '#f1f5f9';
    ctx.font = '11px JetBrains Mono';
    ctx.textAlign = 'left';
    ctx.fillText(formatDuration(ms), labelW + barW + 8, y + barH / 2 + 4);
  });
}

// ===== CHART: Scroll Depth Over Time (line) =====
function drawScrollDepthChart(scrollEvents, startTime) {
  const canvas = document.getElementById('chartScrollDepth');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * dpr;
  canvas.height = 250 * dpr;
  ctx.scale(dpr, dpr);
  const W = canvas.offsetWidth, H = 250;
  const pad = { t: 10, r: 20, b: 30, l: 45 };
  const chartW = W - pad.l - pad.r;
  const chartH = H - pad.t - pad.b;

  if (scrollEvents.length < 2) {
    ctx.fillStyle = '#64748b';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('Not enough scroll data', W / 2, H / 2);
    return;
  }

  const maxTime = scrollEvents[scrollEvents.length - 1].timestamp - startTime;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + (i / 4) * chartH;
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(W - pad.r, y);
    ctx.stroke();
    ctx.fillStyle = '#64748b';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText((i * 25) + '%', pad.l - 6, y + 3);
  }

  // Y axis label
  ctx.save();
  ctx.translate(12, H / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#64748b';
  ctx.font = '10px Inter';
  ctx.textAlign = 'center';
  ctx.fillText('Scroll Depth', 0, 0);
  ctx.restore();

  // Draw line
  ctx.beginPath();
  ctx.strokeStyle = '#a855f7';
  ctx.lineWidth = 2;
  scrollEvents.forEach((ev, i) => {
    const x = pad.l + ((ev.timestamp - startTime) / maxTime) * chartW;
    const y = pad.t + ((ev.data?.scrollPct || 0) / 100) * chartH;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill under
  const lastEv = scrollEvents[scrollEvents.length - 1];
  const lastX = pad.l + ((lastEv.timestamp - startTime) / maxTime) * chartW;
  const lastY = pad.t + ((lastEv.data?.scrollPct || 0) / 100) * chartH;
  ctx.lineTo(lastX, pad.t + chartH);
  ctx.lineTo(pad.l, pad.t + chartH);
  ctx.closePath();
  ctx.fillStyle = 'rgba(168,85,247,0.08)';
  ctx.fill();
}

// ===== CHART: Click Map =====
function drawClickMap(clicks) {
  const canvas = document.getElementById('chartClickMap');
  if (!canvas) return;
  const container = canvas.parentElement;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = container.offsetWidth * dpr;
  canvas.height = container.offsetHeight * dpr;
  ctx.scale(dpr, dpr);
  const W = container.offsetWidth, H = container.offsetHeight;

  // Dark background
  ctx.fillStyle = '#0a1628';
  ctx.fillRect(0, 0, W, H);

  // Draw page outline
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.strokeRect(10, 10, W - 20, H - 20);

  if (clicks.length === 0) {
    ctx.fillStyle = '#64748b';
    ctx.font = '13px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('No clicks recorded', W / 2, H / 2);
    return;
  }

  // Draw clicks as dots
  clicks.forEach(ev => {
    const x = (ev.data?.pctX || 0) / 100 * (W - 20) + 10;
    const y = (ev.data?.pctY || 0) / 100 * (H - 20) + 10;

    // Glow
    const grad = ctx.createRadialGradient(x, y, 0, x, y, 12);
    grad.addColorStop(0, 'rgba(74,158,255,0.6)');
    grad.addColorStop(1, 'rgba(74,158,255,0)');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(x, y, 12, 0, Math.PI * 2);
    ctx.fill();

    // Center dot
    ctx.fillStyle = '#4a9eff';
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
  });

  // Count label
  ctx.fillStyle = '#64748b';
  ctx.font = '10px JetBrains Mono';
  ctx.textAlign = 'right';
  ctx.fillText(clicks.length + ' clicks', W - 16, H - 12);
}

// ===== CHART: Mouse Heatmap =====
function drawMouseHeatmap(mouseBatches) {
  const canvas = document.getElementById('chartMouseHeat');
  if (!canvas) return;
  const container = canvas.parentElement;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = container.offsetWidth * dpr;
  canvas.height = container.offsetHeight * dpr;
  ctx.scale(dpr, dpr);
  const W = container.offsetWidth, H = container.offsetHeight;

  ctx.fillStyle = '#0a1628';
  ctx.fillRect(0, 0, W, H);

  // Collect all positions
  const positions = [];
  mouseBatches.forEach(batch => {
    if (batch.data?.positions) {
      batch.data.positions.forEach(p => {
        positions.push({ x: (p.pctX || 0) / 100 * W, y: (p.pctY || 0) / 100 * H });
      });
    }
  });

  if (positions.length === 0) {
    ctx.fillStyle = '#64748b';
    ctx.font = '13px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('No mouse data recorded', W / 2, H / 2);
    return;
  }

  // Create density grid
  const gridSize = 8;
  const cols = Math.ceil(W / gridSize);
  const rows = Math.ceil(H / gridSize);
  const grid = new Float32Array(cols * rows);

  positions.forEach(p => {
    const col = Math.floor(p.x / gridSize);
    const row = Math.floor(p.y / gridSize);
    if (col >= 0 && col < cols && row >= 0 && row < rows) {
      // Spread to nearby cells
      for (let dy = -2; dy <= 2; dy++) {
        for (let dx = -2; dx <= 2; dx++) {
          const c = col + dx, r = row + dy;
          if (c >= 0 && c < cols && r >= 0 && r < rows) {
            const dist = Math.sqrt(dx * dx + dy * dy);
            grid[r * cols + c] += Math.max(0, 1 - dist / 3);
          }
        }
      }
    }
  });

  const maxDensity = Math.max(...grid) || 1;

  // Draw heatmap
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const val = grid[r * cols + c] / maxDensity;
      if (val > 0.02) {
        const alpha = Math.min(val * 0.8, 0.8);
        // Color gradient: blue -> cyan -> green -> yellow -> red
        let color;
        if (val < 0.25) color = `rgba(74,158,255,${alpha})`;
        else if (val < 0.5) color = `rgba(6,182,212,${alpha})`;
        else if (val < 0.75) color = `rgba(245,158,11,${alpha})`;
        else color = `rgba(239,68,68,${alpha})`;

        ctx.fillStyle = color;
        ctx.fillRect(c * gridSize, r * gridSize, gridSize, gridSize);
      }
    }
  }

  ctx.fillStyle = '#64748b';
  ctx.font = '10px JetBrains Mono';
  ctx.textAlign = 'right';
  ctx.fillText(positions.length + ' points', W - 16, H - 12);
}

// ===== EVENT TIMELINE =====
function renderEventTimeline(events, startTime) {
  const container = document.getElementById('eventTimeline');
  if (!container) return;

  // Show latest 200 events (most recent first)
  const recent = events.slice(-200).reverse();

  container.innerHTML = recent.map(ev => {
    const elapsed = formatDuration(ev.timestamp - startTime);
    const detail = getEventDetail(ev);
    return `<div class="event-item">
      <span class="ei-time">${elapsed}</span>
      <span class="ei-type ${ev.type}">${ev.type}</span>
      <span class="ei-detail">${detail}</span>
    </div>`;
  }).join('');
}

function getEventDetail(ev) {
  const d = ev.data || {};
  switch (ev.type) {
    case 'click':
      return `Clicked <strong>&lt;${escHtml(d.tag || '?')}&gt;</strong>${d.text ? ' "' + escHtml(d.text.substring(0, 40)) + '"' : ''} ${d.section ? 'in <em>' + escHtml(d.section) + '</em>' : ''} at (${d.pctX}%, ${d.pctY}%)`;
    case 'scroll':
      return `Scrolled ${escHtml(d.direction || '')} to <strong>${d.scrollPct}%</strong>${d.section ? ' &mdash; section: <em>' + escHtml(d.section) + '</em>' : ''}`;
    case 'section_enter':
      return `Entered section <strong>${escHtml(d.section || '?')}</strong>`;
    case 'section_exit':
      return `Left section <strong>${escHtml(d.section || '?')}</strong> (spent ${formatDuration(d.duration || 0)})`;
    case 'hover':
      return `Hovered <strong>${escHtml(d.text || d.element || '?')}</strong> for ${formatDuration(d.duration || 0)}${d.section ? ' in <em>' + escHtml(d.section) + '</em>' : ''}`;
    case 'nav_click':
      return `Clicked nav link: <strong>${escHtml(d.text || d.link || '?')}</strong>`;
    case 'visibility':
      return d.visible ? 'Tab became <strong style="color:var(--green)">visible</strong>' : 'Tab became <strong style="color:var(--red)">hidden</strong>';
    case 'mouse_batch':
      return `${d.positions ? d.positions.length : 0} mouse positions recorded`;
    case 'resize':
      return `Window resized to <strong>${d.width}x${d.height}</strong>`;
    default:
      return JSON.stringify(d).substring(0, 100);
  }
}

// ===== UTILITIES =====
function formatDuration(ms) {
  if (ms < 1000) return ms + 'ms';
  const seconds = Math.floor(ms / 1000);
  if (seconds < 60) return seconds + 's';
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  if (minutes < 60) return minutes + 'm ' + secs + 's';
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return hours + 'h ' + mins + 'm';
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
